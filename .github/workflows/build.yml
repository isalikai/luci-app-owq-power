name: Build OWQ Power

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

# 必须添加权限，防止 403 错误
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          path: src

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc wget unzip python3 file aria2

      - name: Cache SDK
        id: cache-sdk
        uses: actions/cache@v3
        with:
          path: sdk
          key: openwrt-sdk-23.05.5-x86-64

      - name: Setup OpenWrt SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          # 下载 OpenWrt 23.05.5 官方 SDK
          aria2c -x 10 -s 10 -k 1M --check-certificate=false https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          
          # 解压
          tar -xf openwrt-sdk-*.tar.xz
          rm openwrt-sdk-*.tar.xz
          mv openwrt-sdk-* sdk
          
          # 初始化 Feeds
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile Package
        run: |
          cd sdk
          # 确保 feeds 存在
          if [ ! -f feeds.conf.default ]; then
            ./scripts/feeds update -a
            ./scripts/feeds install -a
          fi
          
          # 链接源码
          rm -rf package/luci-app-owq-power
          ln -s $GITHUB_WORKSPACE/src package/luci-app-owq-power
          
          # 编译
          make defconfig
          make package/luci-app-owq-power/compile V=s

      - name: Organize Files
        run: |
          mkdir -p bin-output
          find sdk/bin/packages/ -name "luci-app-owq-power*.ipk" -exec cp {} bin-output/ \;
          find sdk/bin/packages/ -name "luci-i18n-owq-power-zh-cn*.ipk" -exec cp {} bin-output/ \;
          ls -lh bin-output/

      - name: Release to GitHub
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: bin-output/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}